---
title: "Calculate OHI scores"
output: html_document
---

R code to calculate OHI scores with the `ohicore` package.

This is an RMarkdown file, where written text appears with a white background and R code appears with a grey background as a "code chunk". You can run R code line-by-line, or as a whole chunk by clicking the green triangle at the top-right corner of the code chunk's grey box.

----
## Install R packages

Run this code chunk one time only to install packages you don't already have. This is like wiring a building for electricity. *Note: warnings are fine.*

```{r install packages, eval=FALSE}
## install packages from R community
install.packages("tidyverse")
install.packages("zoo")
install.packages("here")
install.packages("devtools")

## install the ohicore package from OHI team
devtools::install_github('ohi-science/ohicore@dev')
```

## Load R packages

Run this every time you calculate scores so that you will have libraries available to you. This is like turning on the lights in a building. Additionally, you will set the working directory to your scenario folder. The syntax `::` identifies which library a function is from.

```{r setup, eval=FALSE}
## load package libraries
library(tidyverse)
library(stringr)
library(zoo)
library(here)
library(ohicore)

## set the working directory to a filepath we all have
setwd(here::here('region'))
options(scipen=999)
```


## Calculate and save scores

Run this chunk to calculate and save scores as `scores` object and as `scores.csv`. You can examine `scores.csv` in the Git tab of RStudio to explore what changed.

```{r calculate scores, eval=FALSE}
## calculate scores for each year scenario and save to a single csv file ----

## select scenario year for the assessment
scenario_years <- c(2005:2017)
scores_all_years <- data.frame()

## loop through each scenario year
for (s_year in scenario_years){  # s_year=2015

  message(sprintf('--- Calculating Scores for scenario year %s ----', s_year))

  ## configure checks
  conf   <-  ohicore::Conf('conf')
  layers <-  ohicore::Layers(layers.csv = 'layers.csv', layers.dir = 'layers')
  layers$data$scenario_year <-  s_year

  ## calculate scores
  scores_sy <- ohicore::CalculateAll(conf, layers) %>%
    mutate(year = s_year)

  ## bind scores to dataframe
  scores_all_years <- rbind(scores_all_years, scores_sy)
  
  #add flowerplot code in here so we generate flowerplots for each year. This will need to include s_year in naming

}

## save .csv file
readr::write_csv(scores_all_years, 'scores.csv', na='')
```

## Create figures

Run this to create flower plots for each region.

```{r plot, eval=FALSE}
## source script (to be incorporated into ohicore)
source('conf/arctic_flower_plot.R')

PlotFlower(assessment_name = "US Northeast",
dir_fig_save    = "reports/figures")
```

## Example workflow

These code chunks will help you as you develop individual goal models in `conf/functions.R`. A good workflow is:

1. prepare data layers in the prep/ folders (script as much as possible in R)
2. register data layers in layers.csv and save them in layers/ folder
3. update information in conf/scenario_data_years.csv
4. run the Configure Toolbox code chunk
5. develop goal models in functions.r, running individual goal models line by line
6. calculate scores when the model is developed (remember to re-run Configure Toolbox first!)
